#
# DRSource Multi-Language Rule Knowledge Base
#
# Structure:
# VULNERABILITY_ID:
#   description: "..."
#   cwe: "..."
#   severity: "..."
#
#   # --- General rules, apply to all languages (e.g., secret scanning) ---
#   general_regex_patterns:
#     - id: "..."
#       message: "..."
#       severity: "..."
#       pattern: |
#         ...
#
#   # --- Language-specific rules ---
#   language_specific:
#     java:
#       regex_patterns:
#         - id: "..."
#       ast_sources:
#         - "..."
#       ast_sinks:
#         - "..."
#     python:
#       regex_patterns:
#         - id: "..."
#       ast_sources:
#         - "..."
#       ast_sinks:
#         - "..."
#

# A03:2021 - Injection
SQL_INJECTION:
  description:
    "Building SQL queries by concatenating unvalidated user input leads to SQL
    Injection."
  cwe: "CWE-89"
  severity: "HIGH"

  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-SQLI-001"
          message:
            "SQL query is directly concatenated with user input
            (request.getParameter)."
          severity: "HIGH"
          pattern: |
            (?i)(SELECT|INSERT|UPDATE|DELETE)\s+.*\s+FROM\s+.*\+.*request\.getParameter
        - id: "JAVA-SQLI-002"
          message:
            "Insecure 'Statement.execute' call with string concatenation."
          severity: "HIGH"
          pattern: |
            (?i)^\s*Statement\.execute(Query|Update)?\s*\(.*?\+.*\)
      ast_sources:
        - "request.getParameter"
      ast_sinks:
        - "executeQuery"
        - "executeUpdate"
        - "execute"

    python:
      regex_patterns:
        - id: "PY-SQLI-001"
          message:
            "SQL query constructed with f-string from request data (e.g.,
            request.args)."
          severity: "HIGH"
          pattern: |
            cursor\.execute\s*\(\s*f["'].*(request\.(args|form|json))
      ast_sources:
        # Flask, Django, etc.
        - "request.args.get"
        - "request.form"
        - "request.json"
        - "request.GET.get"
        - "request.POST.get"
      ast_sinks:
        - "cursor.execute"

    php:
      regex_patterns:
        - id: "PHP-SQLI-001"
          message: "SQL query concatenated with $_GET or $_POST variable."
          severity: "HIGH"
          pattern: |
            (mysqli_query|mysql_query|pg_query)\s*\(.*\.\s*\$_(GET|POST)
      ast_sources:
        - "$_GET"
        - "$_POST"
        - "$_REQUEST"
      ast_sinks:
        - "mysqli_query"
        - "mysql_query"
        - "pg_query"

COMMAND_INJECTION:
  description:
    "Building OS commands by concatenating unvalidated user input leads to
    Remote Code Execution (RCE)."
  cwe: "CWE-78"
  severity: "HIGH"

  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-RCE-001"
          message:
            "OS command is built using unvalidated user input
            (request.getParameter)."
          severity: "CRITICAL"
          pattern: |
            Runtime\.getRuntime\(\)\.exec\s*\(.*\+.*request\.getParameter
      ast_sources:
        - "request.getParameter"
      ast_sinks:
        - "Runtime.getRuntime().exec"
        - "new ProcessBuilder"

    python:
      regex_patterns:
        - id: "PY-RCE-001"
          message:
            "Insecure 'os.system' or 'subprocess.Popen' call with shell=True and
            request data."
          severity: "CRITICAL"
          pattern: |
            (os\.system|subprocess\.Popen)\s*\(.*\+.*(request\.(args|form|json))
      ast_sources:
        - "request.args.get"
        - "request.form"
      ast_sinks:
        - "os.system"
        - "subprocess.Popen" # (Need to check for shell=True)
        - "eval"
        - "exec"

    php:
      regex_patterns:
        - id: "PHP-RCE-001"
          message:
            "Insecure 'exec', 'system', or 'passthru' call with $_GET or $_POST
            variable."
          severity: "CRITICAL"
          pattern: |
            (exec|system|passthru|shell_exec|`)\s*\(.*\.\s*\$_(GET|POST)
      ast_sources:
        - "$_GET"
        - "$_POST"
      ast_sinks:
        - "exec"
        - "system"
        - "passthru"
        - "shell_exec"
        - "`" # Backticks operator

XSS:
  description:
    "Writing unvalidated user input directly to an HTML response leads to
    Cross-Site Scripting (XSS)."
  cwe: "CWE-79"
  severity: "HIGH"

  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-XSS-001"
          message:
            "User input is written directly to the HTTP response without
            encoding."
          severity: "HIGH"
          pattern: |
            response\.getWriter\(\)\.print(ln)?\s*\(.*request\.getParameter
      ast_sources:
        - "request.getParameter"
      ast_sinks:
        - "response.getWriter().print"
        - "response.getWriter().println"

    python:
      # Note: Modern frameworks like Django/Flask auto-escape by default.
      # These rules look for deliberate disabling of auto-escaping.
      regex_patterns:
        - id: "PY-XSS-001"
          message:
            "User input rendered with 'Markup' or 'safe' filter, disabling
            auto-escaping."
          severity: "HIGH"
          pattern: |
            (Markup|safe)\s*\(.*(request\.(args|form|json))
      ast_sources:
        - "request.args.get"
      ast_sinks:
        - "Markup" # e.g., in Flask
        - "| safe" # e.g., in Jinja2/Django

# A05:2021 - Security Misconfiguration
HARDCODED_PASSWORD:
  description:
    "Hardcoding passwords, API keys, or other credentials in source code is
    highly insecure."
  cwe: "CWE-798"
  severity: "HIGH"

  # These rules are general and apply to ALL languages
  general_regex_patterns:
    - id: "GEN-PASS-001"
      message: "A hardcoded password appears to be in the code."
      severity: "HIGH"
      pattern: |
        (?i)(password|passwd|pwd)\s*[=:]\s*["'](.{4,})["']
    - id: "GEN-PASS-002"
      message: "A hardcoded API key or access token appears to be in the code."
      severity: "HIGH"
      pattern: |
        (?i)(api_key|apikey|access_token|accesstoken)\s*[=:]\s*["'](.{12,})["']

# A08:2021 - Software and Data Integrity Failures
INSECURE_DESERIALIZATION:
  description:
    "Deserializing untrusted data can lead to Remote Code Execution (RCE)."
  cwe: "CWE-502"
  severity: "HIGH"

  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-DESER-001"
          message:
            "Unsafe deserialization with 'ObjectInputStream.readObject()'."
          severity: "CRITICAL"
          pattern: |
            ObjectInputStream\.readObject\s*\(\)
      ast_sinks:
        - "ObjectInputStream.readObject"
        - "XMLDecoder.readObject"

    python:
      regex_patterns:
        - id: "PY-DESER-001"
          message: "Unsafe deserialization with 'pickle.loads()'."
          severity: "CRITICAL"
          pattern: |
            pickle\.loads\s*\(
      ast_sinks:
        - "pickle.loads"
        - "yaml.load"
OPEN_REDIRECT:
  description:
    "Allowing user input to control a redirect destination can enable phishing
    attacks."
  cwe: "CWE-601"
  severity: "MEDIUM"
  language_specific:
    java:
      ast_sources:
        - "getParameter"
      ast_sinks:
        - "sendRedirect"

PATH_TRAVERSAL:
  description:
    "Using unvalidated user input to build a file path can allow an attacker to
    read or write arbitrary files."
  cwe: "CWE-22"
  severity: "HIGH"
  language_specific:
    java:
      ast_sources:
        - "getParameter"
      ast_sinks:
        # Sinks are the constructors
        - "File"
        - "FileInputStream"
        - "FileOutputStream"
        - "FileReader"

# A02:2021 - Cryptographic Failures
WEAK_CRYPTO:
  description:
    "Using outdated or weak cryptographic algorithms (e.g., DES, MD5, SHA1) is
    insecure."
  cwe: "CWE-327"
  severity: "HIGH"
  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-CRYPTO-001"
          message: "Use of insecure DES cipher. Use AES/GCM/NoPadding instead."
          severity: "HIGH"
          pattern: |
            Cipher\.getInstance\s*\(\s*["']DES
        - id: "JAVA-CRYPTO-002"
          message:
            "Use of insecure hashing algorithm MD5. Use SHA-256 or stronger."
          severity: "HIGH"
          pattern: |
            MessageDigest\.getInstance\s*\(\s*["']MD5
      ast_sinks:
        - "getInstance"
XXE:
  description:
    "Parsing XML from an untrusted source without disabling external entities
    leads to XML External Entity (XXE) attacks."
  cwe: "CWE-611"
  severity: "HIGH"
  language_specific:
    java:
      ast_sinks:
        - "parse"

INSECURE_COOKIE:
  description:
    "Cookies created without the 'HttpOnly' or 'Secure' flags are vulnerable to
    theft."
  cwe: "CWE-1004"
  severity: "MEDIUM"
  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-COOKIE-001"
          message: "Cookie 'HttpOnly' flag is explicitly set to false."
          severity: "MEDIUM"
          pattern: |
            setHttpOnly\s*\(\s*false\s*\)
        - id: "JAVA-COOKIE-002"
          message:
            "Cookie 'Secure' flag is explicitly set to false, allowing it to be
            sent over HTTP."
          severity: "MEDIUM"
          pattern: |
            setSecure\s*\(\s*false\s*\)
SSRF:
  description:
    "Allowing an attacker to control the destination URL of a server-side
    request can lead to SSRF."
  cwe: "CWE-918"
  severity: "HIGH"
  language_specific:
    java:
      ast_sources:
        - "getParameter"
      ast_sinks:
        - "URL" # <-- Coherent: Constructor is the sink
        - "execute"
        - "HttpGet"
        - "HttpPost"
SESSION_FIXATION:
  description:
    "Failure to invalidate the user's session after login, which can allow an
    attacker to use a known session ID."
  cwe: "CWE-384"
  severity: "MEDIUM"
  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-SESS-001"
          message:
            "A user attribute is set on the session. Ensure
            'session.invalidate()' was called before this."
          severity: "MEDIUM"
          # This is a 'noisy' rule to flag potential login points
          pattern: |
            (?i)^\s*session\.setAttribute\s*\(\s*["'](user|username|uid|principal)["']

# A04:2021 - Insecure Design
# (Deprecated API falls here)
DEPRECATED_API:
  description:
    "Using deprecated or obsolete functions that are known to be insecure, such
    as Thread.stop()."
  cwe: "CWE-477"
  severity: "LOW"
  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-DEPR-001"
          message: "Insecure deprecated method 'Thread.stop()' is used."
          severity: "LOW"
          pattern: |
            (?i)\.stop\s*\(\s*\)
        - id: "JAVA-DEPR-002"
          message:
            "Insecure deprecated method 'Thread.suspend()' or 'Thread.resume()'
            is used."
          severity: "LOW"
          pattern: |
            (?i)\.(suspend|resume)\s*\(\s*\)

# A05:2021 - Security Misconfiguration
INFORMATION_DISCLOSURE:
  description:
    "Application leaks sensitive information, such as in error messages or stack
    traces."
  cwe: "CWE-200"
  severity: "LOW"
  general_regex_patterns:
    - id: "GEN-INFO-001"
      message:
        "The application prints a stack trace, which could leak sensitive
        information to an attacker."
      severity: "LOW"
      pattern: |
        (?i)^\s*e\.printStackTrace\(\s*\)

# A08:2021 - Software and Data Integrity Failures
INSECURE_REFLECTION:
  description:
    "Using unvalidated user input to control reflection (e.g., Class.forName())
    can lead to RCE."
  cwe: "CWE-470"
  severity: "HIGH"
  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-REFL-001"
          message:
            "Insecure call to 'Class.forName()' with concatenated user input."
          severity: "HIGH"
          pattern: |
            (?i)^\s*Class\.forName\s*\(.*\+.*request\.getParameter
      ast_sources:
        - "getParameter"
      ast_sinks:
        - "forName"
        - "invoke"
        - "new" # (When used with reflection)

# A03:2021 - Injection
# (JNDI Injection is a form of injection)
JNDI_INJECTION:
  description:
    "Using unvalidated user input in a JNDI lookup can lead to remote code
    execution (RCE)."
  cwe: "CWE-95" # (Related to code injection)
  severity: "CRITICAL"
  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-JNDI-001"
          message:
            "JNDI lookup 'InitialContext.lookup()' is called with concatenated
            user input."
          severity: "CRITICAL"
          pattern: |
            (?i)^\s*InitialContext\.lookup\s*\(.*\+.*\)
      ast_sources:
        - "getParameter"
      ast_sinks:
        - "lookup" # (e.g., InitialContext.lookup)
