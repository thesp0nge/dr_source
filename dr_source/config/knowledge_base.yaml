#
# DRSource Multi-Language Rule Knowledge Base
#
# Structure:
# VULNERABILITY_ID:
#   description: "..."
#   cwe: "..."
#   severity: "..."
#
#   # --- General rules, apply to all languages (e.g., secret scanning) ---
#   general_regex_patterns:
#     - id: "..."
#       message: "..."
#       severity: "..."
#       pattern: |
#         ...
#
#   # --- Language-specific rules ---
#   language_specific:
#     java:
#       regex_patterns:
#         - id: "..."
#       ast_sources:
#         - "..."
#       ast_sinks:
#         - "..."
#     python:
#       regex_patterns:
#         - id: "..."
#       ast_sources:
#         - "..."
#       ast_sinks:
#         - "..."
#

# A03:2021 - Injection
SQL_INJECTION:
  description:
    "Building SQL queries by concatenating unvalidated user input leads to SQL
    Injection."
  cwe: "CWE-89"
  severity: "HIGH"

  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-SQLI-001"
          message:
            "SQL query is directly concatenated with user input
            (request.getParameter)."
          severity: "HIGH"
          pattern: |
            (?i)(SELECT|INSERT|UPDATE|DELETE)\s+.*\s+FROM\s+.*\+.*request\.getParameter
        - id: "JAVA-SQLI-002"
          message:
            "Insecure 'Statement.execute' call with string concatenation."
          severity: "HIGH"
          pattern: |
            (?i)^\s*Statement\.execute(Query|Update)?\s*\(.*?\+.*\)
      ast_sources:
        - "request.getParameter"
      ast_sinks:
        - "executeQuery"
        - "executeUpdate"
        - "execute"

    python:
      regex_patterns:
        - id: "PY-SQLI-001"
          message:
            "SQL query constructed with f-string from request data (e.g.,
            request.args)."
          severity: "HIGH"
          pattern: |
            cursor\.execute\s*\(\s*f["'].*(request\.(args|form|json))
      ast_sources:
        # Flask, Django, etc.
        - "request.args.get"
        - "request.form"
        - "request.json"
        - "request.GET.get"
        - "request.POST.get"
      ast_sinks:
        - "cursor.execute" # Covers all db.cursor.execute()

    php:
      regex_patterns:
        - id: "PHP-SQLI-001"
          message: "SQL query concatenated with $_GET or $_POST variable."
          severity: "HIGH"
          pattern: |
            (mysqli_query|mysql_query|pg_query)\s*\(.*\.\s*\$_(GET|POST)
      ast_sources:
        - "$_GET"
        - "$_POST"
        - "$_REQUEST"
      ast_sinks:
        - "mysqli_query"
        - "mysql_query"
        - "pg_query"

COMMAND_INJECTION:
  description:
    "Building OS commands by concatenating unvalidated user input leads to
    Remote Code Execution (RCE)."
  cwe: "CWE-78"
  severity: "CRITICAL" # <-- Updated

  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-RCE-001"
          message:
            "OS command is built using unvalidated user input
            (request.getParameter)."
          severity: "CRITICAL"
          pattern: |
            Runtime\.getRuntime\(\)\.exec\s*\(.*\+.*request\.getParameter
      ast_sources:
        - "request.getParameter"
      ast_sinks:
        - "exec"
        - "ProcessBuilder"

    python:
      regex_patterns:
        - id: "PY-RCE-001"
          message:
            "Insecure 'os.system' or 'subprocess.Popen' call with shell=True and
            request data."
          severity: "CRITICAL"
          pattern: |
            (os\.system|subprocess\.Popen)\s*\(.*\+.*(request\.(args|form|json))
      ast_sources:
        - "request.args.get"
        - "request.form"
      ast_sinks:
        - "os.system"
        - "subprocess.Popen" # (Analyzer logic should check for shell=True)
        - "eval"
        - "exec"

    php:
      regex_patterns:
        - id: "PHP-RCE-001"
          message:
            "Insecure 'exec', 'system', or 'passthru' call with $_GET or $_POST
            variable."
          severity: "CRITICAL"
          pattern: |
            (exec|system|passthru|shell_exec|`)\s*\(.*\.\s*\$_(GET|POST)
      ast_sources:
        - "$_GET"
        - "$_POST"
      ast_sinks:
        - "exec"
        - "system"
        - "passthru"
        - "shell_exec"
        - "`" # Backticks operator

XSS:
  description:
    "Writing unvalidated user input directly to an HTML response leads to
    Cross-Site Scripting (XSS)."
  cwe: "CWE-79"
  severity: "HIGH"

  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-XSS-001"
          message:
            "User input is written directly to the HTTP response without
            encoding."
          severity: "HIGH"
          pattern: |
            response\.getWriter\(\)\.print(ln)?\s*\(.*request\.getParameter
      ast_sources:
        - "request.getParameter"
      ast_sinks:
        - "print"
        - "println"
        - "write"

    python:
      # Note: Modern frameworks like Django/Flask auto-escape by default.
      # These rules look for deliberate disabling of auto-escaping.
      regex_patterns:
        - id: "PY-XSS-001"
          message:
            "User input rendered with 'Markup' or 'safe' filter, disabling
            auto-escaping."
          severity: "HIGH"
          pattern: |
            (Markup|safe)\s*\(.*(request\.(args|form|json))
      ast_sources:
        - "request.args.get"
      ast_sinks:
        - "Markup" # e.g., in Flask
        - "| safe" # e.g., in Jinja2/Django

# A05:2021 - Security Misconfiguration
HARDCODED_PASSWORD:
  description:
    "Hardcoding passwords, API keys, or other credentials in source code is
    highly insecure."
  cwe: "CWE-798"
  severity: "HIGH"

  # These rules are general and apply to ALL languages
  general_regex_patterns:
    - id: "GEN-PASS-001"
      message: "A hardcoded password appears to be in the code."
      severity: "HIGH"
      pattern: |
        (?i)(password|passwd|pwd)\s*[=:]\s*["'](.{4,})["']
    - id: "GEN-PASS-002"
      message: "A hardcoded API key or access token appears to be in the code."
      severity: "HIGH"
      pattern: |
        (?i)(api_key|apikey|access_token|accesstoken)\s*[=:]\s*["'](.{12,})["']

  language_specific:
    python:
      regex_patterns:
        - id: "PY-SEC-001"
          message: "A hardcoded Django SECRET_KEY was found."
          severity: "HIGH"
          pattern: |
            (?i)^\s*SECRET_KEY\s*=\s*["'](?!YOUR_SECRET_KEY_HERE)

# A08:2021 - Software and Data Integrity Failures
INSECURE_DESERIALIZATION:
  description:
    "Deserializing untrusted data can lead to Remote Code Execution (RCE)."
  cwe: "CWE-502"
  severity: "CRITICAL" # <-- Updated

  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-DESER-001"
          message:
            "Unsafe deserialization with 'ObjectInputStream.readObject()'."
          severity: "CRITICAL"
          pattern: |
            ObjectInputStream\.readObject\s*\(\)
      ast_sinks:
        - "readObject" # (e.g. ObjectInputStream.readObject)

    python:
      regex_patterns:
        - id: "PY-DESER-001"
          message: "Unsafe deserialization with 'pickle.loads()'."
          severity: "CRITICAL"
          pattern: |
            pickle\.loads\s*\(
        - id: "PY-DESER-002"
          message:
            "Unsafe deserialization with 'yaml.unsafe_load()'. Use
            'yaml.safe_load()' instead."
          severity: "CRITICAL"
          pattern: |
            yaml\.unsafe_load\s*\(
      ast_sinks:
        - "pickle.loads"
        - "yaml.unsafe_load" # <-- Updated from yaml.load

OPEN_REDIRECT:
  description:
    "Allowing user input to control a redirect destination can enable phishing
    attacks."
  cwe: "CWE-601"
  severity: "MEDIUM"
  language_specific:
    java:
      ast_sources:
        - "getParameter"
      ast_sinks:
        - "sendRedirect"
    python:
      ast_sources:
        - "request.args.get"
        - "request.form"
      ast_sinks:
        - "redirect"
        - "HttpResponseRedirect"

PATH_TRAVERSAL:
  description:
    "Using unvalidated user input to build a file path can allow an attacker to
    read or write arbitrary files."
  cwe: "CWE-22"
  severity: "HIGH"
  language_specific:
    java:
      ast_sources:
        - "getParameter"
      ast_sinks:
        - "File"
        - "FileInputStream"
        - "FileOutputStream"
        - "FileReader"
    python:
      regex_patterns:
        - id: "PY-PATH-001"
          message: "File path constructed from request data."
          severity: "HIGH"
          pattern: |
            (open|send_file|send_from_directory)\s*\(.*\+.*(request\.(args|form|json))
      ast_sources:
        - "request.args.get"
        - "request.form"
      ast_sinks:
        - "open"
        - "send_file"
        - "send_from_directory"

# A02:2021 - Cryptographic Failures
WEAK_CRYPTO:
  description:
    "Using outdated or weak cryptographic algorithms (e.g., DES, MD5, SHA1) is
    insecure."
  cwe: "CWE-327"
  severity: "HIGH"
  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-CRYPTO-001"
          message: "Use of insecure DES cipher. Use AES/GCM/NoPadding instead."
          severity: "HIGH"
          pattern: |
            Cipher\.getInstance\s*\(\s*["']DES
        - id: "JAVA-CRYPTO-002"
          message:
            "Use of insecure hashing algorithm MD5. Use SHA-256 or stronger."
          severity: "HIGH"
          pattern: |
            MessageDigest\.getInstance\s*\(\s*["']MD5
      ast_sinks:
        - "getInstance"
    python:
      regex_patterns:
        - id: "PY-CRYPTO-001"
          message:
            "Use of insecure hashing algorithm MD5. Use SHA-256 or stronger."
          severity: "HIGH"
          pattern: |
            hashlib\.md5\s*\(`
        - id: "PY-CRYPTO-002"
          message:
            "Use of weak hashing algorithm SHA1. Use SHA-256 or stronger."
          severity: "MEDIUM"
          pattern: |
            hashlib\.sha1\s*\(`
        - id: "PY-CRYPTO-003"
          message:
            "Use of insecure DES cipher from pycryptodome. Use AES instead."
          severity: "HIGH"
          pattern: |
            from\s+Crypto\.Cipher\s+import\s+DES
XXE:
  description:
    "Parsing XML from an untrusted source without disabling external entities
    leads to XML External Entity (XXE) attacks."
  cwe: "CWE-611"
  severity: "HIGH"
  language_specific:
    java:
      ast_sinks:
        - "parse"
    python:
      regex_patterns:
        - id: "PY-XXE-001"
          message:
            "Use of 'xml.etree.ElementTree.parse' is vulnerable to XXE by
            default."
          severity: "HIGH"
          pattern: |
            xml\.etree\.ElementTree\.parse\s*\(`
        - id: "PY-XXE-002"
          message:
            "'lxml.etree.parse' can be vulnerable to XXE if not configured
            securely (e.g., resolve_entities=True)."
          severity: "MEDIUM"
          pattern: |
            lxml\.etree\.parse\s*\(`
      ast_sinks:
        - "xml.etree.ElementTree.parse"
        - "lxml.etree.parse"

INSECURE_COOKIE:
  description:
    "Cookies created without the 'HttpOnly' or 'Secure' flags are vulnerable to
    theft."
  cwe: "CWE-1004"
  severity: "MEDIUM"
  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-COOKIE-001"
          message: "Cookie 'HttpOnly' flag is explicitly set to false."
          severity: "MEDIUM"
          pattern: |
            setHttpOnly\s*\(\s*false\s*\)
        - id: "JAVA-COOKIE-002"
          message:
            "Cookie 'Secure' flag is explicitly set to false, allowing it to be
            sent over HTTP."
          severity: "MEDIUM"
          pattern: |
            setSecure\s*\(\s*false\s*\)
    python:
      regex_patterns:
        - id: "PY-COOKIE-001"
          message:
            "Django 'SESSION_COOKIE_SECURE' is set to False. Cookies may be sent
            over HTTP."
          severity: "MEDIUM"
          pattern: |
            (?i)^\s*SESSION_COOKIE_SECURE\s*=\s*False
        - id: "PY-COOKIE-002"
          message:
            "Django 'SESSION_COOKIE_HTTPONLY' is set to False. Cookies may be
            read by client-side script."
          severity: "MEDIUM"
          pattern: |
            (?i)^\s*SESSION_COOKIE_HTTPONLY\s*=\s*False
        - id: "PY-COOKIE-003"
          message: "Flask 'SESSION_COOKIE_SECURE' is not set to True."
          severity: "MEDIUM"
          pattern: |
            (?i)^\s*app\.config\s*\[\s*['"]SESSION_COOKIE_SECURE['"]\s*\]\s*=\s*False
        - id: "PY-COOKIE-004"
          message: "Flask 'SESSION_COOKIE_HTTPONLY' is not set to True."
          severity: "MEDIUM"
          pattern: |
            (?i)^\s*app\.config\s*\[\s*['"]SESSION_COOKIE_HTTPONLY['"]\s*\]\s*=\s*False

SSRF:
  description:
    "Allowing an attacker to control the destination URL of a server-side
    request can lead to SSRF."
  cwe: "CWE-918"
  severity: "HIGH"
  language_specific:
    java:
      ast_sources:
        - "getParameter"
      ast_sinks:
        - "URL"
        - "execute"
        - "HttpGet"
        - "HttpPost"
    python:
      regex_patterns:
        - id: "PY-SSRF-001"
          message: "A request is made to a URL constructed from user input."
          severity: "HIGH"
          pattern: |
            (requests\.(get|post)|urllib\.request\.urlopen)\s*\(.*\+.*(request\.(args|form|json))
      ast_sources:
        - "request.args.get"
        - "request.form"
      ast_sinks:
        - "requests.get"
        - "requests.post"
        - "urllib.request.urlopen"

SESSION_FIXATION:
  description:
    "Failure to invalidate the user's session after login, which can allow an
    attacker to use a known session ID."
  cwe: "CWE-384"
  severity: "MEDIUM"
  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-SESS-001"
          message:
            "A user attribute is set on the session. Ensure
            'session.invalidate()' was called before this."
          severity: "MEDIUM"
          pattern: |
            (?i)^\s*session\.setAttribute\s*\(\s*["'](user|username|uid|principal)["']
    python:
      regex_patterns:
        - id: "PY-SESS-001"
          message:
            "A user attribute is set on the session. Ensure session was
            invalidated/regenerated on login."
          severity: "MEDIUM"
          pattern: |
            (?i)^\s*session\s*\[\s*['"](user|username|uid)['"]\s*\]\s*=`

# A04:2021 - Insecure Design
DEPRECATED_API:
  description:
    "Using deprecated or obsolete functions that are known to be insecure, such
    as Thread.stop()."
  cwe: "CWE-477"
  severity: "LOW"
  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-DEPR-001"
          message: "Insecure deprecated method 'Thread.stop()' is used."
          severity: "LOW"
          pattern: |
            (?i)\.stop\s*\(\s*\)
        - id: "JAVA-DEPR-002"
          message:
            "Insecure deprecated method 'Thread.suspend()' or 'Thread.resume()'
            is used."
          severity: "LOW"
          pattern: |
            (?i)\.(suspend|resume)\s*\(\s*\)
    python:
      regex_patterns:
        - id: "PY-DEPR-001"
          message:
            "Use of 'os.popen' is deprecated and can be unsafe. Use 'subprocess'
            module instead."
          severity: "LOW"
          pattern: |
            os\.popen\s*\(`

# A05:2021 - Security Misconfiguration
INFORMATION_DISCLOSURE:
  description:
    "Application leaks sensitive information, such as in error messages or stack
    traces."
  cwe: "CWE-200"
  severity: "LOW"
  general_regex_patterns:
    - id: "GEN-INFO-001"
      message:
        "The application prints a stack trace, which could leak sensitive
        information to an attacker."
      severity: "LOW"
      pattern: |
        (?i)^\s*e\.printStackTrace\(\s*\)
  language_specific:
    python:
      regex_patterns:
        - id: "PY-INFO-001"
          message:
            "'traceback.print_exc()' can leak sensitive information. Avoid in
            production."
          severity: "LOW"
          pattern: |
            traceback\.print_exc\s*\(`
        - id: "PY-INFO-002"
          message:
            "Flask/Werkzeug running in debug mode. Do not use in production."
          severity: "HIGH"
          pattern: |
            app\.run\s*\(.*debug\s*=\s*True

# A08:2021 - Software and Data Integrity Failures
INSECURE_REFLECTION:
  description:
    "Using unvalidated user input to control reflection (e.g., Class.forName())
    can lead to RCE."
  cwe: "CWE-470"
  severity: "HIGH"
  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-REFL-001"
          message:
            "Insecure call to 'Class.forName()' with concatenated user input."
          severity: "HIGH"
          pattern: |
            (?i)^\s*Class\.forName\s*\(.*\+.*request\.getParameter
      ast_sources:
        - "getParameter"
      ast_sinks:
        - "forName"
        - "invoke"
        - "new" # (When used with reflection)
    python:
      regex_patterns:
        - id: "PY-REFL-001"
          message:
            "Use of 'getattr', 'setattr', or '__import__' with user-controlled
            data can be dangerous."
          severity: "MEDIUM"
          pattern: |
            (getattr|setattr|__import__)\s*\(.*\+.*(request\.(args|form|json))
      ast_sources:
        - "request.args.get"
        - "request.form"
      ast_sinks:
        - "getattr"
        - "setattr"
        - "__import__"

# A03:2021 - Injection
JNDI_INJECTION:
  description:
    "Using unvalidated user input in a JNDI lookup can lead to remote code
    execution (RCE)."
  cwe: "CWE-95" # (Related to code injection)
  severity: "CRITICAL"
  language_specific:
    java:
      regex_patterns:
        - id: "JAVA-JNDI-001"
          message:
            "JNDI lookup 'InitialContext.lookup()' is called with concatenated
            user input."
          severity: "CRITICAL"
          pattern: |
            (?i)^\s*InitialContext\.lookup\s*\(.*\+.*\)
      ast_sources:
        - "getParameter"
      ast_sinks:
        - "lookup"
    python: {} # Java-specific vulnerability
